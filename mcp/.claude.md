# OneAgent MCP Development Guidelines

## Project Overview

This is the MCP (Model Context Protocol) implementation of OneAgent, built with Python and FastMCP. It provides AI-powered tools that integrate directly with GraphQL APIs through ChatGPT and other AI platforms.

## Architecture

### Core Components
- **FastMCP Framework**: Provides MCP protocol implementation
- **GraphQL Client**: Handles API communication with proper error handling
- **Modular Tools**: Each tool category in separate file for maintainability
- **Configuration Management**: Environment-based configuration with validation

### File Structure
```
mcp/src/
├── main.py              # Main MCP server entry point
├── config.py            # Configuration management utilities
├── graphql_client.py    # GraphQL client with error handling
├── config_tools.py      # Configuration management tools (4 tools)
├── pdf_tools.py         # PDF text extraction tools (1 tool)
├── upload_tools.py      # File upload tools (1 tool)
└── theme_tools.py       # Theme management tools (4 tools)
```

## Development Guidelines

### 1. Python Standards
- **Python 3.8+**: Use modern Python features
- **Type Hints**: Always use type hints for function parameters and returns
- **PEP 8**: Follow Python style guidelines
- **Docstrings**: Use clear, descriptive docstrings for all tools
- **Error Handling**: Implement comprehensive try/catch blocks

### 2. FastMCP Patterns
```python
@mcp.tool()
def tool_name(param1: str, param2: int = 10) -> str:
    """
    Clear description of what this tool does.
    
    Args:
        param1: Description of parameter
        param2: Description with default value
    
    Returns:
        Description of return value
    """
    try:
        # Implementation here
        return "Success message"
    except Exception as e:
        return f"Error: {str(e)}"
```

### 3. GraphQL Integration
- **Always validate inputs** before making GraphQL calls
- **Use the shared GraphQL client** from `graphql_client.py`
- **Handle GraphQL errors** gracefully with descriptive messages
- **Implement retry logic** for network failures
- **Log GraphQL operations** for debugging

### 4. Configuration Management
- **Use environment variables** for all configuration
- **Validate configuration** on startup
- **Provide clear error messages** for missing configuration
- **Mask sensitive data** in responses (API keys, etc.)
- **Support configuration updates** through tools

### 5. Error Handling Standards
```python
try:
    # Main operation
    result = perform_operation()
    return f"Success: {result}"
except ValidationError as e:
    return f"Validation Error: {str(e)}"
except GraphQLError as e:
    return f"GraphQL Error: {str(e)}"
except FileNotFoundError as e:
    return f"File Error: {str(e)}"
except Exception as e:
    return f"Unexpected Error: {str(e)}"
```

## Tool Implementation Guidelines

### 1. Input Validation
- **Validate all parameters** before processing
- **Check file paths** exist and are accessible
- **Validate API responses** before using data
- **Sanitize user inputs** to prevent injection attacks

### 2. Return Format
- **Always return strings** (MCP requirement)
- **Include success/error status** in response
- **Provide actionable information** in error messages
- **Format complex data** as readable text

### 3. Tool Categories

#### Configuration Tools (`config_tools.py`)
- Manage server configuration
- Validate environment variables
- Provide configuration status
- Support configuration updates

#### PDF Tools (`pdf_tools.py`)
- Extract text from PDF files
- Handle file path validation
- Provide metadata information
- Support page limits

#### Upload Tools (`upload_tools.py`)
- Upload files to cloud storage
- Create file document records
- Handle different file types
- Validate file permissions

#### Theme Tools (`theme_tools.py`)
- Update organization branding
- Manage logo files
- Validate theme tokens
- Handle complex theme schemas

## Testing Requirements

### 1. Unit Tests
- **Test each tool individually**
- **Mock external dependencies** (GraphQL, file system)
- **Test error conditions** thoroughly
- **Validate input/output formats**

### 2. Integration Tests
- **Test GraphQL integration** with real endpoints
- **Test file operations** with actual files
- **Test configuration management**
- **Test authentication flows**

### 3. Test Files
- `test_config.py` - Configuration tools testing
- `test_pdf.py` - PDF tools testing
- `test_upload.py` - Upload tools testing
- `test_theme.py` - Theme tools testing
- `test_main_simple.py` - Integration testing

## Loop Prevention System

### Implementation
- **Track failed attempts** per tool
- **Detect repeated failures** with similar parameters
- **Provide explicit "LOOP DETECTED"** messages
- **Guide users toward resolution**

### Agent Behavior
When agents encounter "LOOP DETECTED" errors:
- **STOP** retrying immediately
- **APOLOGIZE** to the user
- **ASK** for clarification or different parameters
- **SUGGEST** alternative approaches

## Security Guidelines

### 1. Credentials Management
- **Never hardcode API keys** or secrets
- **Use environment variables** for all sensitive data
- **Mask sensitive data** in logs and responses
- **Implement proper token refresh** flows

### 2. Input Sanitization
- **Validate file paths** to prevent directory traversal
- **Check file types** and sizes
- **Sanitize user inputs** before GraphQL calls
- **Implement proper error boundaries**

### 3. API Security
- **Use proper authentication headers**
- **Validate API responses** before processing
- **Handle rate limiting** gracefully
- **Implement circuit breakers** for external services

## Performance Guidelines

### 1. File Operations
- **Stream large files** instead of loading into memory
- **Implement progress tracking** for long operations
- **Use appropriate timeouts** for network operations
- **Cache frequently accessed data**

### 2. GraphQL Optimization
- **Use specific field selection** in queries
- **Implement query batching** where appropriate
- **Handle pagination** for large datasets
- **Monitor query performance**

## Development Workflow

### 1. Local Development
```bash
# Set up environment
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Run in development mode
rav dev
# or
uvicorn src.main:app --reload --host 0.0.0.0 --port 8123
```

### 2. Testing
```bash
# Run individual test suites
python src/test_config.py
python src/test_pdf.py
python src/test_upload.py
python src/test_theme.py

# Run integration tests
python src/test_main_simple.py
```

### 3. Debugging
```bash
# Enable debug logging
DEBUG=oneagent:* python src/main.py

# Check configuration
python -c "from src.config import is_configured; print(is_configured())"
```

## Deployment Guidelines

### 1. Production Setup
- **Use production Python environment**
- **Set proper environment variables**
- **Configure proper logging levels**
- **Implement health checks**

### 2. ChatGPT Integration
- **Set up ngrok tunnel** for local development
- **Configure ChatGPT App** with correct endpoint
- **Test all tools** through ChatGPT interface
- **Monitor performance** and errors

### 3. Configuration Management
- **Use `.env.local`** for local development
- **Use environment variables** for production
- **Never commit sensitive data**
- **Implement configuration validation**

## Code Review Checklist

### Before Submitting PR
- [ ] All tools have proper type hints
- [ ] Error handling is comprehensive
- [ ] Input validation is implemented
- [ ] Tests are added/updated
- [ ] Documentation is updated
- [ ] Security best practices followed
- [ ] Performance considerations addressed

### Review Focus Areas
- **Tool implementation** follows patterns
- **Error handling** is comprehensive
- **Security** best practices followed
- **Tests** cover success and error cases
- **Documentation** is clear and complete

## Support and Maintenance

### 1. Monitoring
- **Log all tool executions** with timing
- **Monitor GraphQL errors** and performance
- **Track configuration changes**
- **Monitor file operations**

### 2. Maintenance
- **Update dependencies** regularly
- **Review and update tests** as needed
- **Monitor security advisories**
- **Update documentation** with changes

### 3. Troubleshooting
- **Check configuration** first
- **Review error logs** for patterns
- **Test individual tools** in isolation
- **Verify GraphQL connectivity**

---

**Remember**: This MCP implementation is about making AI agents that actually work with real GraphQL data. Keep the user experience simple while handling complexity behind the scenes.
